<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Bütçe Takibi - 2025</title>
  <style>
    body { font-family: Arial; text-align: center; background: #f5f5f5; }
    h2 { margin-top: 20px; }
    .top-controls { margin-top: 10px; }
    select, .reset-button, .pdf-button {
      padding: 8px;
      font-size: 16px;
      margin: 5px;
    }
    .reset-button {
      background-color: #f44336; color: white; border: none; cursor: pointer;
    }
    .pdf-button {
      background-color: #2196f3; color: white; border: none; cursor: pointer;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(7, 60px);
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    .day {
      width: 60px;
      height: 60px;
      background: white;
      border: 2px solid #444;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: bold;
    }
    .day.kar { background-color: #d4edda; }
    .day.zarar { background-color: #f8d7da; }
    .day.esit { background-color: #fff3cd; }
    .modal {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 2px solid #444;
      padding: 20px;
      z-index: 10;
      display: none;
      max-height: 90vh;
      overflow-y: auto;
    }
    .overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 5;
      display: none;
    }
    .totals {
      margin-top: 30px;
      font-size: 18px;
    }
    input[type="text"], input[type="number"] {
      width: 80%; margin: 5px auto; padding: 5px; display: block;
    }
    .entry-group {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      background: #f9f9f9;
    }
    button { margin: 5px; padding: 6px 10px; }
  </style>
</head>
<body>

<h2>2025 Bütçe Takibi</h2>
<div class="top-controls">
  <select id="month-select" onchange="selectMonth()">
    <option value="0">Ocak</option>
    <option value="1">Şubat</option>
    <option value="2">Mart</option>
    <option value="3" selected>Nisan</option>
    <option value="4">Mayıs</option>
    <option value="5">Haziran</option>
    <option value="6">Temmuz</option>
    <option value="7">Ağustos</option>
    <option value="8">Eylül</option>
    <option value="9">Ekim</option>
    <option value="10">Kasım</option>
    <option value="11">Aralık</option>
  </select>
  <button class="reset-button" onclick="resetMonth()">Bu Ayı Sıfırla</button>
  <button class="pdf-button" onclick="generatePDF()">PDF Raporu Al</button>
</div>

<div class="grid" id="days-grid"></div>
<div class="modal" id="modal">
  <h3 id="modal-day">Gün</h3>
  <div id="income-entries"></div>
  <button onclick="addIncomeEntry()">+ Gelir Kalemi</button>
  <div id="expense-entries"></div>
  <button onclick="addExpenseEntry()">+ Gider Kalemi</button>
  <br>
  <button onclick="saveData()">Kaydet</button>
</div>
<div class="overlay" id="overlay" onclick="closeModal()"></div>
<div class="totals" id="summary"></div>
<canvas id="hiddenChart" style="display:none;width:800px;height:400px;"></canvas>

<script>
// Buraya kadar her şey entegre edildi.

const daysGrid = document.getElementById("days-grid");
const modal = document.getElementById("modal");
const overlay = document.getElementById("overlay");
const modalDay = document.getElementById("modal-day");
const incomeContainer = document.getElementById("income-entries");
const expenseContainer = document.getElementById("expense-entries");
const summary = document.getElementById("summary");
const monthSelect = document.getElementById("month-select");
const aylar = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];

let currentMonth = parseInt(monthSelect.value);
let currentDay = null;

function getMonthKey() {
  return `data-${currentMonth}`;
}

function selectMonth() {
  currentMonth = parseInt(monthSelect.value);
  renderCalendar();
  updateSummary();
}

function renderCalendar() {
  daysGrid.innerHTML = "";
  const daysInMonth = new Date(2025, currentMonth + 1, 0).getDate();
  for (let i = 1; i <= daysInMonth; i++) {
    const dayBox = document.createElement("div");
    dayBox.className = "day";
    dayBox.innerText = i;
    dayBox.id = `day-${i}`;
    dayBox.onclick = () => openModal(i);
    daysGrid.appendChild(dayBox);
  }
  updateColors();
}

function resetMonth() {
  const ayAdi = aylar[currentMonth];
  const confirmReset = confirm(`${ayAdi} ayını sıfırlamak üzeresiniz. Tüm veriler silinecek. Emin misiniz?`);
  if (!confirmReset) return;

  const allData = JSON.parse(localStorage.getItem("butce2025")) || {};
  delete allData[getMonthKey()];
  localStorage.setItem("butce2025", JSON.stringify(allData));
  renderCalendar();
  updateSummary();
}

function createEntryElement(type, value = "", note = "") {
  const div = document.createElement("div");
  div.className = "entry-group";
  div.innerHTML = `
    <input type="text" placeholder="Açıklama" value="${note}" class="${type}-note">
    <input type="number" placeholder="${type} Tutarı" value="${value}" class="${type}-amount">
  `;
  return div;
}

function openModal(day) {
  currentDay = day;
  modalDay.innerText = `${day} ${aylar[currentMonth]}`;
  incomeContainer.innerHTML = "";
  expenseContainer.innerHTML = "";

  const allData = JSON.parse(localStorage.getItem("butce2025")) || {};
  const data = allData[getMonthKey()] || {};
  const entry = data[day] || { incomes: [], expenses: [] };

  (entry.incomes || []).forEach(item => incomeContainer.appendChild(createEntryElement("income", item.amount, item.note)));
  (entry.expenses || []).forEach(item => expenseContainer.appendChild(createEntryElement("expense", item.amount, item.note)));

  modal.style.display = "block";
  overlay.style.display = "block";
}

function closeModal() {
  modal.style.display = "none";
  overlay.style.display = "none";
}

function addIncomeEntry() {
  incomeContainer.appendChild(createEntryElement("income"));
}
function addExpenseEntry() {
  expenseContainer.appendChild(createEntryElement("expense"));
}

function saveData() {
  const allData = JSON.parse(localStorage.getItem("butce2025")) || {};
  const data = allData[getMonthKey()] || {};
  const incomes = Array.from(document.querySelectorAll(".income-amount")).map((el, i) => ({ amount: parseFloat(el.value) || 0, note: document.querySelectorAll(".income-note")[i].value || "" })).filter(i => i.amount > 0);
  const expenses = Array.from(document.querySelectorAll(".expense-amount")).map((el, i) => ({ amount: parseFloat(el.value) || 0, note: document.querySelectorAll(".expense-note")[i].value || "" })).filter(e => e.amount > 0);
  data[currentDay] = { incomes, expenses };
  allData[getMonthKey()] = data;
  localStorage.setItem("butce2025", JSON.stringify(allData));
  closeModal(); updateSummary(); updateColors();
}

function updateSummary() {
  const allData = JSON.parse(localStorage.getItem("butce2025")) || {};
  const data = allData[getMonthKey()] || {};
  let totalIncome = 0, totalExpense = 0;
  for (const day in data) {
    totalIncome += data[day].incomes.reduce((sum, item) => sum + item.amount, 0);
    totalExpense += data[day].expenses.reduce((sum, item) => sum + item.amount, 0);
  }
  const net = totalIncome - totalExpense;
  summary.innerHTML = `Toplam Gelir: ${totalIncome.toFixed(2)} TL<br>Toplam Gider: ${totalExpense.toFixed(2)} TL<br>Toplam Kar/Zarar: ${net.toFixed(2)} TL`;
}

function updateColors() {
  const allData = JSON.parse(localStorage.getItem("butce2025")) || {};
  const data = allData[getMonthKey()] || {};
  for (let i = 1; i <= 31; i++) {
    const box = document.getElementById(`day-${i}`);
    if (!box) continue;
    box.classList.remove("kar", "zarar", "esit");
    const entry = data[i];
    if (entry) {
      const gelir = entry.incomes.reduce((s, v) => s + v.amount, 0);
      const gider = entry.expenses.reduce((s, v) => s + v.amount, 0);
      const net = gelir - gider;
      if (net > 0) box.classList.add("kar");
      else if (net < 0) box.classList.add("zarar");
      else if (net === 0 && (gelir > 0 || gider > 0)) box.classList.add("esit");
    }
  }
}

function generatePDF() {
  if (!window.jspdf || !Chart) {
    alert("Gerekli kütüphaneler yüklenemedi. Lütfen internet bağlantınızı kontrol edin.");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const monthName = aylar[currentMonth];
  const allData = JSON.parse(localStorage.getItem("butce2025")) || {};
  const data = allData[getMonthKey()] || {};
  let y = 10;
  doc.setFontSize(16);
  doc.text(`${monthName} 2025 - Gelir Gider Raporu`, 10, y);
  y += 10;
  doc.setFontSize(12);
  for (let day = 1; day <= 31; day++) {
    if (data[day]) {
      const incomes = data[day].incomes || [];
      const expenses = data[day].expenses || [];
      doc.text(`${day} ${monthName}`, 10, y);
      y += 6;
      incomes.forEach(inc => { doc.text(`Gelir: ${inc.amount.toFixed(2)} TL - ${inc.note}`, 12, y); y += 6; });
      expenses.forEach(exp => { doc.text(`Gider: ${exp.amount.toFixed(2)} TL - ${exp.note}`, 12, y); y += 6; });
      y += 4;
      if (y > 270) { doc.addPage(); y = 10; }
    }
  }
  const canvas = document.getElementById("hiddenChart");
  const ctx = canvas.getContext("2d");
  const labels = [], karZarar = [];
  for (let i = 1; i <= 31; i++) {
    if (data[i]) {
      const gelir = data[i].incomes.reduce((s, v) => s + v.amount, 0);
      const gider = data[i].expenses.reduce((s, v) => s + v.amount, 0);
      labels.push(`${i}`);
      karZarar.push(gelir - gider);
    }
  }
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{ label: 'Günlük Kar/Zarar', data: karZarar, backgroundColor: 'rgba(75, 192, 192, 0.5)' }]
    },
    options: {
      responsive: false,
      animation: {
        onComplete: function () {
          const imgData = canvas.toDataURL("image/png");
          doc.addPage();
          doc.addImage(imgData, 'PNG', 15, 20, 180, 90);
          doc.save(`${monthName}-2025-Rapor.pdf`);
        }
      }
    }
  });
}
</script>

</body>
</html>
